# As of October 24
active_set = [4069944,3387105,3887481,1618930,3485987,1875529,4008588,246730,3525404,4023641,2744540,4019755,2005415,3024930,2278967,3351436,3824285,2559284,3893218,2821123,2057822,3766532,3767552,3163396,2628179,3530081,4008544,2078912,4027838,4050768,2540350,2404911,2423422,3414168,4066260,3103755,2144345,2173013,3582767,3739701,4072932,3798247,1499756,3054995,3786200,851566,4069941,3691770,1338756,2964104,1552894,1694987,2182659,3859518,3906677,4034986,4057030,4014487,1530314,3682795,1792941,2268434,3413655,4076158,987860,1678405,2965253,4076179,576845,3329693,1610274,3341542,2897941,1627087,2930698,3111411,2297498,3884763,1566389,3800968,247840,3955799,246072,2156263,2193499,2156268,3669753,2497435,2497427,2547997,2497413,2497418,2497422,2497430,1637643,4014941,3894297,2241824,711914,3662983,2772631,529768,4050489,3824477,3628928,2823765,3624164,4057829,3297514,2796299,3874296,1954338,2843671,3970740,3562613,2687207,3102957,2249115,2169960,4034381,2383016,2359864,4009935,1905878,3893309,1444287,3943014,3178562,763447,3842505,2137044,3895296,3352123,3268082,2996815,1124214,2047670,3745700,3213309,3850699,3949375,3506054,3031286,2512456,2736874,4072931,3449090,3326244,882408,1679242,3278547,1147173,4037796,3207328,3965967,4069784,4069861,4069864,4069865,4069863,2571974,2906885,2168123,3907260,3300610,4018276,3005467,3136936,3005457,3005465,3726565,2182928,4004239,1844915,3992606,2507656,630927,2426393,1648018,3307909,2421531,3783088,4024247,3557279,849260,1576625,1466679,3685563,3700862,4018284,2720657,3619471,4018287,3627681,2707123,2463730,4044310,3356536,3500835,3160766,1797044,1904280,3719549,2270432,3023990,3806418,3115097,3644111,1466239,1733172,2805705,2446104,2423467,688552,3990101,2230306,1595693,3804526,1488218,2756548,2524135,3595753,3655512,566967,3528597,3990097,3757366,3956434,3992613,2954255,1420344,2328114,2616783,3738826,3563657,2928079,1620136,1978840,3783238,2988201,3746136,2487300,2426464,3941422,4044288,3647883,2970279,4082415,3749003,3225298,2997542,2965991,3908557,4003357,3949378,1457779,1749582,3835187,893475,4056236,2522524,2386022,3486502,3999735,529120,2955746,1530444,2699084,3448838,3401549,3926084,3662048,2837956,3412620,3950160,1335795,3335770,3706125,1357495,3467658,3430470,3663328,2815213,2585866,2947790,3389963,2568723,698247,2200428,904674,2831132,3893467,4010097,2742115,1191236,2291117,2984456,3946950,3207380,2011460,2696047,3997632,3034241,237343,2903859,446602,3767705,2634018,4019397,1629726,3467960,1410131,1547334,1952646,2875076,4055149,1369872,3873486,3841602,741590,4025061,3993357,3949214,2690199,3811852,1799337,3978388,3656884,3861911,1995810,1826367,3704065,3437015,3701230,3964517,1410130,1461363,2449129,3304880,883623,2965115,3909954,4017905,4059796,3891395,3816870,3632758,4018275,3593104,4018273,4018271,4018269,3983305,267501,4017589,4018272,4017584,2089536,3966032,3966030,3966029,3966024,3966022,3966020,3875896,2503629,3764472,4067781,536267,3049997,2755579,2272090,4033411,2959072,3743656,2444835,3446983,3806356,2408916,3345701,3749781,2992197,3036065,3941800,1933569,1766066,3970360,4018681,4010870,2834106,1124047,4015156,4027443,904879,4027442,4027428,520129,4027425,4027416,4027410,3795050,1844982,3537363,3850792,3750734,3970229,3339317,1546061,684659,2522472,3628193,1215754,4029883,2691601,1186848,4008351,1834595,3959424,4049123,1512270,2773512,2406493,4018060,3272249,3555049,3423512,4078116,4044308,2871603,4061478,3699891,1526077,1416241,3035494,4005700,4009088,4056413,3104836,3994244,2137115,3892157,1607377,1932217,3991831,4002865,1584267,1442983,1611334,3482099,3363997,1838988,1567450,3330805,1853248,1957659,2566682,3052006,2511755,3961436,4044912,3623117,4009977,3454973,3879462,2503677,1403952,3616985,1561358,1526385,2509798,4014494,2662287,3413076,3611145,2746317,3774466,1599858,3903700,2575018,1584790,3708710,3427850,3271014,3271860,3970226,834376,3514367,1458280,3966243,3010924,1571785,770149,2171888,2171884,3965994,2866253,4007512,4013428,3005438,3298662,3567335,4013663,3836346,3965990,3153137,1104648,2683708,1997729,3869738,2558081,2969878,4055157,693552,2625637,3485886,2815899,2515404,3192429,3946895,3274486,2156259,2156241,2156235,1880835,1522167,3194883,1360528,1600076,3965017,3022407,4019761,3925231,3915440,3857152,3857143,2538890,3804912,3414376,2507679,1886196,3852826,3852851,2750761,3852850,2948456,3609731,4066978,4081373,3964211,3940130,3297336,3173941,3852859,171316,3301590,1103169,2729793,2875745,2875744,2561038,3768562,3092327,3194603,3163767,3484529,2800540,2544758,534038,2832460,3412625,4002439,2691309,3337353,3852827,4056043,3485540,2393553,3718229,4004772,1525519,3641527,2498435,726692,3297551,3823104,4008543,4059605,3497722,2100054,2567819,2658815,3912545,856459,4025063,3745691,3498353,2405985,3535212,4025059,3636669,4049450,4059510,2936591,4048924,3519202,3949316,3998700,1206555,3074757,3692575,3831926,4010312,3476017,4018453,4010327,2934832,1987828,3854086,1814076,3983304,4056316,3643738,3875058,1452828,1733081,4046087,1909730,1176698,3991880,3067986,2362700,1727380,2193491,3381228,2854606,2894360,3025042,3774619,4069992,3766361,3705521,3838144,2538056,3779319,2656370,3428371,3855215,399634,3840830,3857263,3252578,3011689,4044392,3982297,3041962,1718554,3840488,3170898,3987754,3993194,4034093,3774102,1376813,3549843,3655701,3663896,3554814,3598059,3824001,2170064,4044285,4093348,4081363,3350021,3999398,4025881,4103223,4057435,4044461,4044331,4083447,2456548,3991909,2890400,4065367,4046728,3986986,3898221,4003394,3998531,4040721,4102948,3986993,4071329,1379297,1854973,3564760,4030155,3960224,3601924,3633393,3601934,3960355,3248718,2866866,3626930,3548828,3812589,3633172,3853886,3754431,2538211,2651405,1110153,3376967,3427561,3620547,3706490,3873453,2624724,3290002,2627131,3315128,3618826,1008009,3136456,2057849,1501263,3098001,596402,3455743,425336,3296379,3952786,3705733,2481764,3761651,2204622,2086926,3898827,3388102,3848845,3972715,2659499,3437062,2723601,3601920,3193906,2637624,571851,3548825,2204719,307812,3071983,2410613,1650173,2184781,3384292,2099994,941799,1414413,792139,2678016,3434712,2637633,2937379,520145,1423734,655703,3074841,222869,878483,1413722,1875586,295737,3856086,3931022,3848605,2438286,2452483,1633912,814094,3522174,2837994,2772397,3587693,2637646,3007908,3312758,2810023,1046093,3220637,3590809,1174844,2170010,2467926,1791188,702963,1090881,502178,248289,1406257,2449033,2631591,2697106,2328296,1801829,3097232,3616220,1775620,3317424,3780848,3848640,965192,882858,1489501,2445019,269545,3255191,2545890,3351540,3743365,3792479,3812156,986086,3569606,3522136,2212528,3375637,1882713,2365175,3228504,1813848,3700206,3846539,2818610,2845132,3825366,3965195,1535833,3171470,2948020,3523247,3827615,2195694,3763258,3915239,2772698,2395586,1763482,2355245,1731740,2709631,2894962,1749190,1879987,3486527,852310,3634303,3829306,2030865,1876587,2734743,2637635,2056438,2969248,1660665,3786481,2226687,2392257,2553115,1699878,1987781,1108426,2799992,2762573,3976742,2820665,2641935,2077357,2987635,3848595,2268827,1472042,304810,3406351,1564112,3693732,1600391,2896650,3158178,3009066,1746842,2488215,1111879,2432710,3258155,3132762,3871860,1629329,2745705,3286532,3924202,3656417,1595844,3601930,3601907,3527643,3424007,2057854,2898768,2917663,3705753,2458053,2844179,1804299,3387283,2729557,3088068,2799399,3695135,651549,3874186,2746196,550789,3942614,3790866,2381550,1989180,2884178,1808120,3383849,3158336,3413974,2638058,1406692,3976743,3058217,3446851,2292829,3563598,3449753,3687358,2968822,2121915,3499280,3075807,3783927,1056026,2606886,2515698,1509223,3677731,1578904,3440565,2698243,3384288,3875441,1172741,1646298,3049889,3698863,240567,1841930,3581336,2844182,1433823,3989208,2135928,1602109,2637460,2156256,1835031,4007667,2252163,1024283,2773470,2922413,3505754,3342430,3160630,3259588,868168,3361014,198699,1596184,1858393,2136193,1660621,1111954,3748458,952610,849384,3749332,3727174,3745952,1395448,3838098,860430,2388813,1558347,3362112,827553,2989730,2061630,1914964,3679021,3724460,584642,2571254,3684513,3693706,1426179,3317324,2691614,3256430,3555975,1971416,3222407,445101,1170974,1918541,1472899,1336885,1037559,3687346,3304009,1645428,2578595,3711150,684993,3416404,2812380,1660014,149938,2637628,2778446,2959067,2928793,3369112,2451878,2461831,2521284,2222432,3649146,1602191,2742757,2687731,2534397,577911,2511560,2970799,3873506,1599929,3501155,3123171,2194104,2259017,473781,2218454,513872,1876573,3196733,1169237,1461839,1582187,3567156,2306831,3070893,2187534,3084509,3818834,3604787,444499,1592463,2853080,1499799,3690760,3934730,1993930,3341913,1179551,1097361,410947,2758031,3775919,2215981,1788210,4015451,2648678,1553279,2431611,1826327,3812192,2461829,2805511,2326708,1887702,1024252,2057995,1737892,3213872,2283726,2578598,79362,448139,3601121,2876766,998086,3348279,4027438,2357926,1633921,3724777,3861701,3413608,3256847,3316499,3175993,2791575,3611396,2387081,2681156,2927906,1403748,2220199,1849166,1560854,1501311,2842051,1428160,3137024,1963045,3752305,3124983,3342719,2578599,2872377,866727,3723778,3260734,3929867,3739663,2112059,3950801,2184178,610486,2326712,2937604,3343679,449859,3794425,2911194,293124,3055405,2503687,3567707,3131357,231679,3865782,531450,986833,2786059,1617128,1440856,306807,665178,1836140,1492051,1529833,676705,1430841,818719,857900,1941266,2271527,1801598,1826017,2239542,3593457,3084302,985210,2745787,2948470,974764,3677123,2374506,3847678,3419850,3684562,4006912,1499268,2094944,1489356,1907637,2248090,2346375,2120797,3721279,1785270,2372739,1513033,2719690,3436498,3692834,3498465,3043193,3780376,2529698,1596784,2183941,1875857,3837543,3554956,2833145,1904895,2069963,2387410,3897773,1855055,3133156,3739171,3597060,2145336,1089033,2842866,3687815,3656277,3275889,1953927,3140202,3369177,2797026,2592965,3610091,2810589,1392324,1913173,2344878,1723937,2438816,2970358,2190096,3762813,1390130,2898630,2848872,2937062,2477527,1055899,3264810,2166096,2818040,2135727,2522716,2315952,3799556,2443854,3432946,3242962,3869323,2239874,1509473,2061797,2936958,3468748,2525025,2513429,3289323,3266946,3447960,3491460,3067598,2443929,3737972,3117602,3054124,1702763,1398451,3856659,2875051,1764218,3834931,2008734,3056145]
# pending_application_set = [1511717,3803104,4037393,3745084,4081474,4055199,4081480,3720928,3331576,4066317,4069878,1864693,4029812,4024928,4076938,3784879,3987324,3919369,4017493,3354357,3842441,4037337,2784256,3218958,2954202,2691040,2978556,4009814,3949901,4072930,4046085,3925492,3112756,3706046,4035434,2671795,3381467,4044796,4091490,4050268,4034110,4009362,3626800,4098744,4065349,4067702,4117019,4043721,3987789,4009357,4051928,4061863,4043734,4056040,4092419,4081491,4098679,4054388,4057870,4066183,4075965,4028148,4067694,4024924,4054798,4044914,4009162,4070649,4055887,4039712,4072413,4051271,4009186,4052024,4035890,4025547,4045125,4065218,4044645,4067754,4098677,4064435,4008550,4051258,4038908,2172819,4061903,2757924,2565661,2757963,4043719,3631626,3663583,4009682,914040,2757966,3970698,3589144,3840423,3926062,3882045,3409365,3973792,4029636,3712555,3843295,2931694,3906508,4038048,2404626,2866324,3601922,3698807,3988421,1036269,2379951,3364711,3226308,3745086,3897426,2426167,3569293,3533497,3631617,2403902,3912058,3280955,943766,2217108,1602947,3954995,3737597,3274222,2595496,2078064,3778910,3949914,4049535,3986594,3187929,3641695,3912698,3900854,247913,2728387,3357525,3886831,3840938,3490835,3934613,3874101,1763106,3735627,3716953,3334993,1948080,3521025,3257076,3806565,1169006,3886674,2461402,1767811,2837214,3521168,3946952,2826756,4009717,3526199,3605997,2760812,3938211,3844200,1636472,3949929,3082516,2962979,3585914,1926808,3600617,3761272,3926140,4018689,2977911,2095332,3788044,1512223,3698244,3818103,3422717,4043704,3999192,3865967,3252327,3930502,3959279,3484321,996479,1729448,2283207,4007758,3934555,3800140,3829513,3684443,3518043,3726291,3602365,2473727,3295320,2777100,3361933,2478376,3600793,3979062,1598897,497935,2777740,3068918,1120868,3701754,898472,1839800,4024878,2720728,2466656,2736130,2746548,2362571,3449096,3319446,3348873,513096,3250622,3662813,565703,2736124,1994554,3144657,1603335,3930322,2746504,2974472,4008051,3560316,3893954,2040510,1431080,2619757,3096409,2134008,3929883,3092288,3961981,1831089,464089,3872323,2139042,3457560,3970806,3274079,2542022,2431768,1974399,2903258,3377485,2691607,2760735,2477714,3862833,3955296,2755472,3264343,3506213,2019171,2884302,2724900,3931452,1880882,2995908,2777545,3781174,3383804,3434401,4003114,3456530,767685,2659473,1481202,2195674,3958272,2200154,2123642,3275502,2861228,1694957,3936405,3754885,1798207,4009856,3214882,2872021,2184926,1977127,824094,3854036,1698436,857021,2456792,3805502,943328,3370699,3428680,1694038,3912286,3793612,3768420,576917,2709377,2334644,3241869,2619820,3846457,3517902,2031500,853989,3644071,2343773,3953882,3483353,3752192,3214875,2893427,3779157,3743636,1476814,3450927,3103627,3950930,3792305,2131516,1835540,1934854,3312802,1415425,2747226,1919535,3778972,3585747,2201649,2909763,1604489,2743018,3337626,2859345,1440670,2806538,2954010,331744,2971891,1664191,3038801,3692301,1564046,2357845,242732,1817900,2969770,1625589,2166878,1475547,3390083,3510879,1656602,3799579,1706705,3302976,2120189,1610793,3955042,3849722,2679311,3335251,3692632,2202848,2409825,3493922,2352856,2324734,2495039,3396628,3470945,3840613,2261810,582806,3522308,1768952,3226127,2778949,2259013,2971889,1593258,3274480,2551382,2449164,1666237,2067802,3566177,1460329,3711405,2213024,3767654,4038154,1838477,2546168,2466495,2012901,3719111,2266255,1359466,3504604,1610772,2234018,3605554,1769625,3179724,1610790,3194253,825733,3462570,2361943,3139700,2957446,3522077,3274077,3769189,3713759,3650496,3885078,3274072,1734903,3547065,2190127,3929006,2955694,2478411,3099532,3713769,667758,1475632,2333769,3677020,2515458,3110279,758183,3387931,2336709,3818674,3932116,2790730,3499948,3766500,2825971,1605893,1515487,3684709,3944173,256357,2175920,3844442,3090276,3534011,2511859,2223275,3452864,3195092,3514211,2740601,2971892,2591316,2823660,3949469,3773784,1437201,3115296,3800966,3949104,2220159,3044792,3731285,3278515,1980103,2826752,2753491,2127008,1045525,3982180,3609917,3785010,3355834,4028216,3341823,2968531,2381116,2011339,2884295,4038033,2449644,1672838,3179838,3448671,3564589,3534989,1036127,1681549,1618656,3776933,3693885,3110443,1480012,3514164,2335573,671051,1903515,3263333,2806455,2506827,2590430,3730166,3446929,2963929,2193092,3835168,3672190,3580650,2398482,2200605,3900677,3611517,3885691,3296790,3193005,4038123,3514382,3348440,1511922,2616908,2088604,2084191,2958418,2036529,854349,3011813,2658715,3259243,2188468,2002791,3422719,2195679,3769182,3344421,2176643,2138908,2195669,3711923,3407281,4043712,3117796,2443932,1485184,3090237,3930319,2866670,1815767,3522338,3858664,3836241,2905841,1785676,2271086,2833928,2126999,3110325,3115291,3876526,1703616,3993961,3609169,3172521,2382983,3904858,2962985,1819722,3874915,3953897,1520299,2489979,3903335,3290091,736645,2842709,3067609,3894482,1896463,1400962,2150771,3945923,3785394,1866842,3164021,2859498,3364243,1343419,3186496,2661540,2796552,3272986,3581714]

namespace :scrape do
  desc "TODO"
  task cj: :environment do
		time_start = Time.now
		# encoding_converter = Iconv.new('UTF-8', 'LATIN1')

		# Initiate a Mechanize object, request for pepperjam site and log in with credentials.
		agent = Mechanize.new
		target_host = 'http://www.cj.com/'
		agent.get(target_host) do |page|
		  login_form = page.form_with(id: 'user-login') do |form|
			form.uname = ENV['CJ_UN']
			form.pw = ENV['CJ_PW']
		  end
		  login_form.submit
		end

		detail_url = "https://members.cj.com/member/accounts/publisher/getadvertiserdetail.do?advertiserId="
		iterate_count = active_set.count
		scraping_count = 0

		# 200.times do |i|
		active_set.count.times do |i|
			adv_page = agent.get(detail_url + active_set[i].to_s)

			report_table = adv_page.search('.report')
			primary_name = adv_page.search("td[@class='dashed']").text.strip
			secondary_name = Domainatrix.parse(adv_page.search('a')[1].text).domain
			adv_desc = adv_page.search("[text()*='Description']").first.parent.text.split("Description:")[1].strip.gsub(/\n|\s{2,}/," ")

			protected_kws_raw = report_table.xpath("//*[starts-with(@id, 'PROTECTED_SEM_BIDDING_KEYWORDS_value')]")[0]
			protected_kws_clean = protected_kws_raw == nil ? "" : protected_kws_raw.text.strip

			noncompete_kws_raw = report_table.xpath("//*[starts-with(@id, 'NON_COMPETE_SEM_BIDDING_KEYWORDS_value')]")[0]
			noncompete_kws_clean = noncompete_kws_raw == nil ? "" : noncompete_kws_raw.text.strip

			sem_instruction_raw = report_table.xpath("//*[starts-with(@id, 'SPECIAL_SEM_INSTRUCTION_value')]")[0]
			sem_instruction_clean = sem_instruction_raw == nil ? "" : sem_instruction_raw.text.strip

			restricted_kws = protected_kws_clean + noncompete_kws_clean + sem_instruction_clean

		  Merchant.create(
			  count: 								i + 1,
			  cj_id: 								active_set[i],
			  primary_name: 				primary_name,
			  secondary_name: 			secondary_name,
			  status: 							"active",
			  desc: 								adv_desc,
			  protected_kws: 				restricted_kws,
			  bidding_policy: 			check_policy(primary_name, secondary_name, adv_desc, restricted_kws),
			  page_url: 						detail_url + active_set[i].to_s
		  )

		  scraping_count += 1
		  puts "Scraping.. total of #{scraping_count} so far."
		end

		time_finished = Time.now
		seconds_taken = time_finished - time_start
		puts "This rake task has taken #{seconds_taken} secs or #{seconds_taken / 60} minutes."
  end

end

#############################################################################################
# Helper Functions - Scanner
#############################################################################################

def check_policy(primary_name, secondary_name, description, restricted_keywords)

	# Step 1: Strong negagtive indicator check
  if check_strong_neg(description + restricted_keywords) != 0
    return "prohibited"

  # Step 2-A: Implied negagtive indicator check by primary name
  elsif restricted_keywords.downcase.scan(primary_name.downcase).count != 0
    return "prohibited"

  # Step 2-B: Implied negagtive indicator check by secondary name
  elsif restricted_keywords.downcase.scan(secondary_name.downcase).count != 0
    return "prohibited"

  # Step 2-C: Implied negagtive indicator check by implied negative phrases
  elsif check_implied_neg(description + restricted_keywords) != 0
   	return "prohibited"

  # Step 4: Interpret as an implied positive if not caught by none of the above
  else
    return "allowed"
  end
end

def check_strong_neg(text_for_scan)
  detected_indicator = 0
  strong_negatives = ["no tm bidding",
                      "no trade mark bidding",
                      "no trademark bidding",
                      "no keyword bidding",
                      "no brand bidding",
                      "not allow trademark",
                      "not allow tm bidding",
                      "(PPC) is not permitted",
                      "PPC is not permitted",
                      "No Paid Search permitted",
                      "PPC puclishers are not accepted",
                      "no kw bidding",
                      "no paid search allowed",
                      "Search traffic is not allowed",
                      "trademark is not allowed",
                      "branded keywords bidding is not allowed",
                      "tm bidding is not allowed",
                      "trademark bidding is not allowed",
                      "trademark bidding not allowed",
                      "search markeing is now closed",
                      "trademarks or any variation",
                      "tm bidding is prohibited",
                      "tm bidding prohibited",
                      "sem is not allowed",
                      "trademark bidding is prohibited",
                      "trademark bidding prohibited"]

  strong_negatives.each do |neg|
    break if detected_indicator != 0
    detected_indicator += (text_for_scan).downcase.scan(neg).count
  end
  return detected_indicator
end

def check_implied_neg(text_for_scan)
  detected_indicator = 0
  implied_negatives = ["not permitted to bid",
                       "may not bid",
                       "prohibited to bid",
                       "any variation",
                       "misspelling",
                       "not allow trademark",
                       "any variation",
                       "prohibited from bidding on keywords",
                       "any derivative",
                       "do not bid",
                       "not allowed to bid on",
                       "misspellings",
                       "not bid on trademark",
                       "not bid on any branded terms",
                       "from bidding on the trademark",
                       "no bidding on our brand",
                       "any trademark bidding",
                       "not allow ppc",
                       "no ppc is allowed",
                       "sem is not allowed",
                       "no ppc bidding",
                       "no bidding",
                       "no sem brand",
                       "no sem",
                       "sem is forbidden",
                       "sem is not permitted",
                       "brand based keywords",
                       "not allow paid search",
                       "bidding on our trademark terms",
                       "bidding on trademark",
                       "any brand name",
                       "brand terms is not permitted",
                       "not allow publishers to use search marketing",
                       "any sem bidding",
                       "including but not limited to"]

  implied_negatives.each do |neg|
    break if detected_indicator != 0
    detected_indicator += (text_for_scan).downcase.scan(neg).count
  end
  return detected_indicator
end


# table = adv_page.search('.report')
# table.xpath("//*[starts-with(@id, 'PROTECTED_SEM_BIDDING_KEYWORDS_value')]")[0]
# table.xpath("//*[starts-with(@id, 'NON_COMPETE_SEM_BIDDING_KEYWORDS_value')]")[0]
# table.xpath("//*[starts-with(@id, 'SPECIAL_SEM_INSTRUCTION_value')]")[0]

# "PROTECTED_SEM_BIDDING_KEYWORDS_value"
# "NON_COMPETE_SEM_BIDDING_KEYWORDS_value"
# "SPECIAL_SEM_INSTRUCTION_value"